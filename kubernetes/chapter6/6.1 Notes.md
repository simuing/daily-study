# 6장 쿠버네티스의 저장소 활용하기

컨테이너 위에서 돌아가는 애플리케이션은 컨테이너 내부에 격리된 저장공간을 사용하기 때문에 이 공간은 컨테이너가 종료될 때 같이 삭제된다. 라이프 사이클이 컨테이너와 동일한 것이다.

하지만 많은 개발자는 파일을 저장할 때 그 파일이 영속성(persistence)을 가질 것을 기대한다. 이러한 어려움을 해결하기 위하여 쿠버네티스는 저장소와 관련된 다양한 옵션을 제공하고 있다.

## 6.1 파드에 임시 저장공간 확보하기

### Volume

- **볼륨(volume)**: 파드 내부의 컨테이너가 사용할 수 있는 저장공간
-  **마운트(mount)**: 볼륨을 컴퓨터가 사용할 수 있도록 적용하는 과정
- 기본적으로 볼륨은 디렉터리이며, 일부 데이터가 있을 수 있으며, 파드 내 컨테이너에서 접근할 수 있다.
- 쿠버네티스는 다양한 유형의 볼륨을 지원한다. 파드는 여러 볼륨 유형을 동시에 사용할 수 있다. 
- 임시 볼륨 유형은 파드의 수명을 갖지만, 퍼시스턴트 볼륨은 파드의 수명을 넘어 존재한다.  파드가 더 이상 존재하지 않으면, 쿠버네티스는 임시(ephemeral) 볼륨을 삭제하지만, 퍼시스턴트(persistent) 볼륨은 삭제하지 않는다. 볼륨의 종류와 상관없이, 파드 내의 컨테이너가 재시작되어도 데이터는 보존된다.
- 볼륨을 사용하려면, .spec.volumes 에서 파드에 제공할 볼륨을 지정하고 .spec.containers[*].volumeMounts 의 컨테이너에 해당 볼륨을 마운트할 위치를 선언한다. 컨테이너의 프로세스는 컨테이너 이미지의 최초 내용물과 컨테이너 안에 마운트된 볼륨(정의된 경우에 한함)으로 구성된 파일시스템을 보게 된다. 프로세스는 컨테이너 이미지의 최초 내용물에 해당되는 루트 파일시스템을 보게 된다. 쓰기가 허용된 경우, 해당 파일시스템에 쓰기 작업을 하면 추후 파일시스템에 접근할 때 변경된 내용을 보게 될 것이다. 볼륨은 이미지의 특정 경로에 마운트된다. 파드에 정의된 각 컨테이너에 대해, 컨테이너가 사용할 각 볼륨을 어디에 마운트할지 명시해야 한다.


### emptyDir

파일 다운로드를 위해 애플리케이션이 임시 저장공간에 파일을 생성한 뒤 사용자에게 전달하는 경우 파일 다운로드가 끝난 뒤에는 해당 파일을 더 이상 쓰지 않기 때문에 일반적으로 삭제한다.

이렇게 파드보다 짧은 생명주기를 가지는 파일을 저장할 때 사용하는 저장소가 `emptyDir`이다. `emptyDir`은 파드가 생성될 때 같이 생성되는 비어 있는 저장공간이며, 파드가 종료될 때 같이 사라진다. 이러한 특성 덕분에 `emptyDir`은 임시 파일을 저장하는 저장소로 많이 사용된다.

이러한 저장소를 파드에 추가해서 애플리케이션이 사용할 수 있도록 하려면 다음과 같이 파드의 명세를 정의하면 된다.

```yaml
#chapter6/my-pod-01.yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  volumes: #(1)
  - name: temp-volume
    emptyDir: {}
  containers:
  - name: first-container
    image: my-app:1.0.0
    volumeMounts: #(2)
    - mountPath: /temp
      name: temp-volume
  - name: second-container
    image: another-app:1.0.0
    volumeMounts: #(3)
    - mountPath: /storages/files
      name: temp-volume
```
- (1) `temp-volume`이라는 이름을 가진 볼륨을 파드 내부 임시 저장소인 `emptyDir`로 정의한다.
- (2) 아래 `temp-volume`으로 정의된 저장공간을 `first-container` 컨테이너의 `/temp` 경로에 연결한다.
- (3) `temp-volume`을 `second-container`의 `/storages/files` 경로에 연결한다.

`first-container`의 `/temp` 디렉터리와 `second-container`의 `/storages/files` 디렉터리는 실제로 같은 저장공간에 연결되어 있다. 이러한 파드는 `emptyDir` 형태의 볼륨을 정의하고, 컨테이너에는 볼륨 마운트를 명시하여 해당 볼륨을 컨테이너와 연결한다.

해당 저장공간이 물리적으로 워커 노드 내부에 있긴 하지만 논리적으로는 해당 파드에서만 접근 가능하기 때문에 파드 내부의 저장공간이며 그 파드에 속한 컨테이너만 접근 가능한 공간이라고 이해해도 된다.

`emptyDir`로 정의한 저장공간이 공유되는 범위는 하나의 파드 내부에 한정되며 서로 다른 파드가 저장공간을 공유하지 않는다.